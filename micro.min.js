var __extends=this&&this.__extends||function(){var extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,b){d.__proto__=b}||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p]};return function(d,b){extendStatics(d,b);function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)}}();var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var __assign=this&&this.__assign||Object.assign||function(t){for(var s,i=1,n=arguments.length;i<n;i++){s=arguments[i];for(var p in s)if(Object.prototype.hasOwnProperty.call(s,p))t[p]=s[p]}return t};function jsonParse(obj,cbFunc){function _jsonParse(path,key,value,cbFunc){var path2=key?path+"/"+key:path;path2=path2.replace("/[","[");if(Array.isArray(value)){for(var n=0;n<value.length;n++){_jsonParse(path2,"["+n+"]",value[n],cbFunc)}}else if(typeof value=="object"){cbFunc(path2,null,null);for(var n_1 in value){_jsonParse(path2,n_1,value[n_1],cbFunc)}}else{cbFunc(path,key,String(value))}}_jsonParse("","",obj,cbFunc)}var MicroHub=function(){function MicroHub(){this._registrations={};this._registrationsId=0;this._store={}}MicroHub.prototype._findStoreObject=function(path){var p=this._store;var steps=path.substr(1).split("/");while(steps.length>0&&p[steps[0]]){p=p[steps[0]];steps.shift()}while(steps.length>0){p=p[steps[0]]={};steps.shift()}return p};MicroHub.prototype.subscribe=function(matchPath,fCallback,replay){if(replay===void 0){replay=false}var h=this._registrationsId;var rn=matchPath.toLocaleLowerCase();var re="^"+rn.replace(/(\[|\]|\/|\?)/g,"\\$1").replace(/\*\*/g,"\\S{0,}").replace(/\*/g,"[^/?]*")+"$";var newEntry={id:h,match:RegExp(re),callback:fCallback};this._registrations[h]=newEntry;this._registrationsId++;if(replay){jsonParse(this._store,function(path,key,value){var fullPath=path+(key?"?"+key:"");if(fullPath){fullPath=fullPath.toLocaleLowerCase();if(fullPath.match(newEntry.match))newEntry.callback(path,key?key.toLowerCase():null,value)}}.bind(this))}return h};MicroHub.prototype.unsubscribe=function(h){this._registrations[h]=null};MicroHub.prototype.publishObj=function(obj){jsonParse(obj,function(path,key,value){this.publishValue(path,key?key.toLowerCase():null,value)}.bind(this))};MicroHub.prototype.publishValue=function(path,key,value){var fullPath=path+(key?"?"+key:"");if(fullPath){if(key){var p=this._findStoreObject(path);p[key]=value}fullPath=fullPath.toLocaleLowerCase();Object.values(this._registrations).forEach(function(r){if(fullPath.match(r.match))r.callback(path,key,value)})}};MicroHub.prototype.onunload=function(evt){for(var n in this._registrations){this._registrations[n].callback=null;this._registrations[n]=null}};return MicroHub}();var hub=new MicroHub;window.addEventListener("unload",hub.onunload.bind(hub),false);var MicroRegistry=function(){function MicroRegistry(){this._registry={};this.List=[]}MicroRegistry.prototype.init=function(){this._tco=document.getElementById("u-templates");if(!this._tco){var t=document.createElement("div");t.id="u-templates";this._tco=document.body.appendChild(t)}};MicroRegistry.prototype.loadFile=function(fName){var scope=this;var ret=fetch(fName).then(function(result){return result.text()}).then(function(html){var f=document.createRange().createContextualFragment(html);scope._tco.appendChild(f)});return ret};MicroRegistry.prototype.attach=function(elem){var mb=elem.getAttribute("u-is");var bc=this._registry[mb];if(bc){this.loadBehavior(elem,bc)}};MicroRegistry.prototype._setPlaceholders=function(obj,props){var _this=this;function fill(val,props){for(var p in props)val=val.replace(new RegExp("\\$\\{"+p+"\\}","g"),props[p]);return val}if(obj.nodeType==3){obj.textContent=fill(obj.textContent,props)}else if(obj.nodeType==1){var el=obj;for(var i=0;i<el.attributes.length;i++){var v=el.attributes[i].value;if(v.indexOf("${")>=0){el[el.attributes[i].name]=el.attributes[i].value=fill(v,props)}}el.childNodes.forEach(function(c){_this._setPlaceholders(c,props)})}};MicroRegistry.prototype.insertTemplate=function(root,controlName,props){var e=null;if(root&&controlName){var te=this._tco.querySelector('[u-control="'+controlName+'"]');if(te)e=te.cloneNode(true);if(e){this._setPlaceholders(e,props);root.appendChild(e)}}return e};MicroRegistry.prototype.loadBehavior=function(obj,behavior){if(obj==null){console.error("loadBehavior: obj argument is missing.")}else if(behavior==null){console.error("loadBehavior: behavior argument is missing.")}else if(obj._attachedBehavior==behavior){}else{if(behavior.inheritFrom){micro.loadBehavior(obj,behavior.inheritFrom);micro.List.pop()}if(obj.attributes){for(var n=0;n<obj.attributes.length;n++)if(obj[obj.attributes[n].name]==null)obj[obj.attributes[n].name]=obj.attributes[n].value}for(var p in behavior){if(p.substr(0,2)=="on"){obj.addEventListener(p.substr(2),behavior[p].bind(obj),false)}else if(behavior[p]==null||behavior[p].constructor!=Function){if(obj[p]==null)obj[p]=behavior[p]}else{obj[p]=behavior[p]}}obj._attachedBehavior=behavior;obj.connectedCallback(obj);this.List.push(obj)}};MicroRegistry.prototype.FindBehaviorElement=function(obj){while(obj&&obj._attachedBehavior==null)obj=obj.parentNode;return obj};MicroRegistry.prototype.define=function(name,mixin){this._registry[name]=mixin};MicroRegistry.prototype.onunload=function(evt){for(var n in this.List){var obj=this.List[n];if(obj&&obj.term)obj.term();for(var a=0;a<obj.attributes.length;a++)obj[obj.attributes[a].name]=null}for(var n in this.List){this.List[n]=null}};return MicroRegistry}();var micro=new MicroRegistry;window.addEventListener("load",micro.init.bind(micro));window.addEventListener("unload",micro.onunload.bind(micro));var obs=new MutationObserver(function(mutationsList,observer){for(var _i=0,mutationsList_1=mutationsList;_i<mutationsList_1.length;_i++){var mutation=mutationsList_1[_i];mutation.addedNodes.forEach(function(n){if(n.getAttribute&&n.getAttribute("u-is"))micro.attach(n)})}});obs.observe(document,{childList:true,subtree:true});function MicroControl(isSelector){return function(target){console.info("MicroControl "+target.name+" registered for "+isSelector);micro.define(isSelector,new target);return target}}var MicroBaseControl=function(){function MicroBaseControl(){}MicroBaseControl.prototype.connectedCallback=function(el){this.el=el};return MicroBaseControl}();var GenericWidgetClass=function(_super){__extends(GenericWidgetClass,_super);function GenericWidgetClass(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.microid="";_this.data={};return _this}GenericWidgetClass.prototype.connectedCallback=function(el){_super.prototype.connectedCallback.call(this,el);this.data={id:this.microid};hub.subscribe(this.microid+"?*",this.newData.bind(this),true)};GenericWidgetClass.prototype.newData=function(path,key,value){this.data[key]=value;var ic=this.el.querySelector("img");if(ic){setAttribute2(ic,"title",JSON.stringify(this.data,null,1).replace("{\n","").replace("\n}",""))}["span","div"].forEach(function(elType){this.el.querySelectorAll(elType+"[u-active='"+key+"']").forEach(function(el){var b=toBool(value);setAttribute2(el,"value",b?"1":"0");setAttribute2(el,"title",b?"active":"not active");el.classList.toggle("active",b)})},this);["h2","h4","span"].forEach(function(elType){this.el.querySelectorAll(elType+"[u-text='"+key+"']").forEach(function(el){if(el.textContent!=value)el.textContent=value})},this);this.el.querySelectorAll("input[u-value='"+key+"']").forEach(function(el){if(el.value!=value)el.value=value})};GenericWidgetClass.prototype.dispatchAction=function(prop,val){if(val!=null)fetch("/$board"+this.microid+"?"+prop+"="+encodeURI(val))};GenericWidgetClass.prototype.onchange=function(e){var src=e.srcElement;this.dispatchAction(src.getAttribute("u-value"),e.srcElement.value)};GenericWidgetClass.prototype.onclick=function(e){var src=e.srcElement;var a=src.getAttribute("u-action");if(a)this.dispatchAction(a,e.srcElement["value"]);if(src.classList.contains("setconfig")){this.el.classList.toggle("configmode")}};return GenericWidgetClass}(MicroBaseControl);GenericWidgetClass=__decorate([MicroControl("generic")],GenericWidgetClass);var ButtonBehavior=function(_super){__extends(ButtonBehavior,_super);function ButtonBehavior(){return _super!==null&&_super.apply(this,arguments)||this}ButtonBehavior.prototype.onpointerdown=function(e){var src=e.srcElement;if(src.classList.contains("u-button")){src.classList.add("active");this.dispatchAction("value",1)}};ButtonBehavior.prototype.onpointerup=function(e){var src=e.srcElement;if(src.classList.contains("u-button")){src.classList.remove("active");this.dispatchAction("value",0)}};return ButtonBehavior}(GenericWidgetClass);ButtonBehavior=__decorate([MicroControl("button")],ButtonBehavior);var DSTimeClass=function(_super){__extends(DSTimeClass,_super);function DSTimeClass(){return _super!==null&&_super.apply(this,arguments)||this}DSTimeClass.prototype.isoDate=function(){function pad02(num){return(num<10?"0":"")+num}var d=new Date;var ds=d.getFullYear()+"-"+pad02(d.getMonth()+1)+"-"+pad02(d.getDate())+" "+pad02(d.getHours())+":"+pad02(d.getMinutes())+":"+pad02(d.getSeconds());return ds};DSTimeClass.prototype.connectedCallback=function(el){_super.prototype.connectedCallback.call(this,el);this._nowObj=this.el.querySelector(".now");window.setInterval(function(){setTextContent(this._nowObj,this.isoDate())}.bind(this),200)};DSTimeClass.prototype.onclick=function(e){var src=e.srcElement;if(src.classList.contains("setnow")){this.dispatchAction("time",this.isoDate())}};return DSTimeClass}(GenericWidgetClass);DSTimeClass=__decorate([MicroControl("dstime")],DSTimeClass);var PWMOutWidgetClass=function(_super){__extends(PWMOutWidgetClass,_super);function PWMOutWidgetClass(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.range=255;return _this}PWMOutWidgetClass.prototype.connectedCallback=function(el){_super.prototype.connectedCallback.call(this,el);hub.subscribe(this.microid+"?*",this.newValue.bind(this))};PWMOutWidgetClass.prototype.newValue=function(path,key,value){if(key=="range"){this.range=Number(value)}else if(key=="value"){if(this.lastValue!==value){var o=this.el.querySelector(".u-level");var h=o.offsetHeight;var bh=h*Number(value)/this.range;if(bh>h-1)bh=h-1;if(bh<1)bh=1;o.style.borderBottomWidth=bh+"px";this.lastValue=value}}};return PWMOutWidgetClass}(GenericWidgetClass);PWMOutWidgetClass=__decorate([MicroControl("pwmout")],PWMOutWidgetClass);var SwitchWidgetClass=function(_super){__extends(SwitchWidgetClass,_super);function SwitchWidgetClass(){return _super!==null&&_super.apply(this,arguments)||this}SwitchWidgetClass.prototype.onclick=function(e){var o=this.el.querySelector(".u-switch");var src=e.srcElement;while(src!=null&&src!=this.el&&src!=o)src=src.parentElement;if(src==o)this.dispatchAction("toggle",1)};return SwitchWidgetClass}(GenericWidgetClass);SwitchWidgetClass=__decorate([MicroControl("switch")],SwitchWidgetClass);var TimerWidgetClass=function(_super){__extends(TimerWidgetClass,_super);function TimerWidgetClass(){var _this=_super!==null&&_super.apply(this,arguments)||this;_this.wt=0;_this.pt=0;_this.ct=0;_this.time=0;return _this}TimerWidgetClass.prototype._timeToSec=function(v){var ret=0;v=v.toLowerCase();if(v.endsWith("h")){ret=parseInt(v,10)*60*60}else if(v.endsWith("m")){ret=parseInt(v,10)*60}else if(v.endsWith("s")){ret=parseInt(v,10)}else{ret=Number(v)}return ret};TimerWidgetClass.prototype.newData=function(path,key,value){_super.prototype.newData.call(this,path,key,value);if(key=="waittime"){this.wt=this._timeToSec(value)}else if(key=="pulsetime"){this.pt=this._timeToSec(value)}else if(key=="cycletime"){this.ct=this._timeToSec(value)}else if(key=="time"){this.time=this._timeToSec(value)}if(this.ct<this.wt+this.pt)this.ct=this.wt+this.pt;if(this.ct>0){var el=this.el.querySelector(".u-bar");var f=el.clientWidth/this.ct;var pto=el.querySelector(".pulse");pto.style.left=Math.floor(this.wt*f)+"px";pto.style.width=Math.floor(this.pt*f)+"px";var cto=el.querySelector(".current");cto.style.width=Math.floor(this.time*f)+"px"}};return TimerWidgetClass}(GenericWidgetClass);TimerWidgetClass=__decorate([MicroControl("timer")],TimerWidgetClass);function toBool(s){if(!s)return false;switch(s.toLowerCase().trim()){case"true":case"yes":return true;case"false":case"no":case"0":case null:return false;default:return Boolean(s)}}function setTextContent(el,txt){if(el.textContent!==txt)el.textContent=txt}function setAttribute2(el,name,value){if(el.getAttribute(name)!==value)el.setAttribute(name,value)}function getHashParams(defaults){var params=__assign({},defaults);window.location.hash.substr(1).split("&").forEach(function(p){var pa=p.split("=");params[pa[0]]=pa[1]});return params}