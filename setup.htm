<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Setup WiFi</title>
</head>

<body style="width:300px">
  <h1>Setup WiFi</h1>
  <div style="display:grid;grid-template-columns: 10ch auto;grid-gap:1ch;">
    <label>Devicename:</label><span id="d">xyz</span>
    <label>Network:</label><span><select id="n" style="width:12em">
        <option selected disabled>scanning...</option>
      </select></span>
    <label>Passphrase:</label><input id="pass" type="password" style="width:12em"></input>
  </div>
  <div style="text-align: right;"><button id="b">Connect</button></div>
  <hr>
  <p style="text-align: right;"><a id="nextLink" title="next step" href="/$update.htm" style="text-decoration: none;">&gt;&gt;&gt;</a></p>

  <script>
    var d = document;
    var state = 0;  // 0: start, 1: get sysinfo, 2: sysinfo-done,  3: scan, 4, scan-done
    var timer;
    var oSel = d.getElementById('n');

    function check() {
      if (state == 0) {
        // start sysinfo
        state = 1;
        fetch('/$sysinfo')
          .then(function (result) {
            return (result.text());
          }).then(function (t) {
            if (t.length > 0) {
              var dn = JSON.parse(t).devicename;
              d.getElementById('d').textContent = dn;
              var a = d.getElementById('nextLink');
              a.href = a.href.replace(/\/\/[^\/]+\//, '//' + dn + '/');
              state = 2;
            } // if
          });

      } else if (state == 2) {
        // start scan 
        state = 3;
        fetch('/$scan')
          .then(function (result) {
            return (result.text());
          }).then(function (t) {
            if (t.length == 0) {
              state = 2;
            } else {
              state = 4;
              scanned(JSON.parse(t));
            }
          });
      } else if (state == 4) {
        window.clearInterval(timer);
        timer = 0;
      } // if
    } // check()

    function scanned(netList) {
      oSel.innerHTML = '';

      var o = d.createElement('option');
      o.value = 0;
      o.text = 'select...';
      o.disabled = true;
      oSel.options.add(o);

      netList.forEach(function (n) {
        var o = d.createElement('option');
        o.value = o.text = n.id;
        oSel.options.add(o);
      });
    } // scanned()

    // connect using network name and password
    d.getElementById('b').addEventListener('click', function () {
      fetch('/$connect?n=' + oSel.value + '&p=' + d.getElementById('pass').value);
    });
    timer = window.setInterval(check, 800);
  </script>
</body>