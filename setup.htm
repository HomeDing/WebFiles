<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WiFi Setup</title>
</head>

<body>
  <h1>WiFi Setup</h1>
  <h2>Connect to network</h2>
  <table>
    <tr>
      <td>Devicename:</td>
      <td id="devname">xyz</td>
    </tr>
    <tr>
      <td>Network:</td>
      <td><select id="conNet" style="width:18em">
          <option selected disabled>scanning...</option>
        </select></td>
    </tr>
    <tr>
      <td>Passphrase:</td>
      <td><input id="pass" style="width:18em"></input></td>
    </tr>
  </table>
  <button id="bCon">Connect</button>
  <script>
    var state = 0;  // 0: start, 1: get sysinfo, 2: sysinfo-done,  3: scan, 4, scan-done
    var timer;
    var oSel = document.getElementById('conNet');
    var devname;

    function load(url, func) {
      var xhr = new XMLHttpRequest(); // new ActiveXObject("MSXML2.XMLHTTP");
      xhr.open('GET', url, true);
      xhr.addEventListener('readystatechange', function (p) {
        if (xhr.readyState == 4) {
          if ((xhr.status >= 200) && (xhr.status < 300)) {
            func(xhr.responseText);
          } // if
        } // if
      });
      xhr.send();
    } // load()

    function check() {
      if (state == 0) {
        // start sysinfo
        state = 1;
        load('/$sysinfo', function (t) {
          if (t.length > 0) {
            document.getElementById('devname').textContent = devname = JSON.parse(t).devicename;
            state = 2;
          }
        });

      } else if (state == 2) {
        // start scan 
        state = 3;
        load('/$scan', function (t) {
          if (t.length == 0) {
            state = 2;
          } else {
            state = 4;
            scanned(JSON.parse(t));
          }
        });
      } else if (state == 4) {
        window.clearInterval(timer);
        timer = 0;
      } // if
    } // check()

    function scanned(netList) {
      oSel.innerHTML = "";

      var o = document.createElement('option');
      o.value = 0;
      o.text = 'select...';
      o.disabled = true;
      oSel.options.add(o);

      netList.forEach(function (n) {
        var o = document.createElement('option');
        o.value = o.text = n.id;
        oSel.options.add(o);
      });
    } // scanned()

    // connect using network name and password
    document.getElementById('bCon').addEventListener('click', function () {
      load('/$connect?n=' + oSel.value + '&p=' + document.getElementById('pass').value,
        function () { });
    });
    timer = window.setInterval(check, 800);
  </script>
</body>